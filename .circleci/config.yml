version: 2
jobs:
  setup:
    machine:
      image: 'ubuntu-1604:201903-01'
    steps:
      - checkout
      - run: 
          name: Install Docker
          command: |
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
            sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
            sudo apt-get update
            apt-cache policy docker-ce
            sudo apt-get install -y docker-ce
  build:
    machine:
      image: 'ubuntu-1604:201903-01'
    steps:
      - run:
          name: Authenticate with AWS ECR
          command: |
            pip install awscli
            AWS_ACCESS_KEY_ID=$AWS_ACCESS AWS_SECRET_ACCESS_KEY=$AWS_SECRET aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 662730807386.dkr.ecr.us-east-1.amazonaws.com
      - run: 
          name: Build Docker Image
          command: docker build -t 662730807386.dkr.ecr.us-east-1.amazonaws.com/indorphins:$(git tag --list | tail -n 1) .;
      - run:
          name: Push Docker Image to ECR 
          command: docker push 662730807386.dkr.ecr.us-east-1.amazonaws.com/indorphins:$(git tag --list | tail -n 1);

workflows:
  version: 2
  setup_and_build:
    jobs:
      - setup:
          filters:
            branches:
              only:
                - master
                - develop
      - build:
          filters:
            branches:
              only:
                - master
                - develop
          requires:
            - setup
           